-- 現貨成交明細資料清理：確保更換過身分證字號的帳戶只保留最新身分證字號的交易紀錄
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
        RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
        RTRIM(LTRIM(BROKER_NO4)) AS BROKER_NO4,
        AMT,
        CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD
FROM ODS.dbo.STS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015'
		AND STATIC_CODE = '000')
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BIRTH) = 1 THEN DATEDIFF(YEAR, S_BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.ST_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BIRTH) = 1)
, MATCH_DAY AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		CASE WHEN ISDATE(MTH_DATE) = 1 THEN CONVERT(DATE, MTH_DATE) ELSE NULL END AS MTH_DATE,
		RTRIM(LTRIM(TRADE_KIND2)) AS TRADE_KIND2,
		MTH_AMT
FROM ODS.dbo.ST_MATCH_D
WHERE ISDATE(MTH_DATE) = 1 
		AND LEFT(MTH_DATE, 4) >= '2015') 
SELECT MATCH_DAY.MTH_DATE AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
        CUSTOMER_INFO.S_ACNO AS S_ACNO,
        CUSTOMER_INFO.GENDER AS GENDER,
        CUSTOMER_INFO.AGE AS AGE,
        STAT_DAY.BROKER_NO4 AS BROKER_NO4,
        STAT_DAY.AMT AS AMT,
        MATCH_DAY.TRADE_KIND2 AS TRADE_KIND,
        MATCH_DAY.MTH_AMT AS MTH_AMT
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN MATCH_DAY ON STAT_DAY.S_ACNO = MATCH_DAY.S_ACNO AND STAT_DAY.DATE_YMD = MATCH_DAY.MTH_DATE AND STAT_DAY.BROKER_NO4 = MATCH_DAY.BROKER_NO4

-- 現貨委託明細
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4)) AS BROKER_NO4,
		AMT,
		CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD
FROM ODS.dbo.STS_ORDER_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015')
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BIRTH) = 1 THEN DATEDIFF(YEAR, S_BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.ST_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BIRTH) = 1)
, MATCH_DAY AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		CASE WHEN ISDATE(ORD_DATE) = 1 THEN CONVERT(DATE, ORD_DATE) ELSE NULL END AS ORD_DATE
FROM ODS.dbo.ST_ORDER_D
WHERE ISDATE(ORD_DATE) = 1 
		AND LEFT(ORD_DATE, 4) >= '2015') 
SELECT MATCH_DAY.ORD_DATE AS MTH_DATE,
		CUSTOMER_INFO.S_IDNO AS S_IDNO,
		CUSTOMER_INFO.S_ACNO AS S_ACNO,
		CUSTOMER_INFO.GENDER AS GENDER,
		CUSTOMER_INFO.AGE AS AGE,
		STAT_DAY.BROKER_NO4 AS BROKER_NO4,
		STAT_DAY.AMT AS AMT
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN MATCH_DAY ON STAT_DAY.S_ACNO = MATCH_DAY.S_ACNO AND STAT_DAY.DATE_YMD = MATCH_DAY.ORD_DATE AND STAT_DAY.BROKER_NO4 = MATCH_DAY.BROKER_NO4

-- 非當沖客人數
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
        RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
        RTRIM(LTRIM(BROKER_NO4)) AS BROKER_NO4,
        AMT,
        CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD
FROM ODS.dbo.STS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015'
		AND STATIC_CODE = '000')
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BIRTH) = 1 THEN DATEDIFF(YEAR, S_BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.ST_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BIRTH) = 1)
, MATCH_DAY AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		CASE WHEN ISDATE(MTH_DATE) = 1 THEN CONVERT(DATE, MTH_DATE) ELSE NULL END AS MTH_DATE,
		RTRIM(LTRIM(TRADE_KIND2)) AS TRADE_KIND2,
		MTH_AMT
FROM ODS.dbo.ST_MATCH_D
WHERE ISDATE(MTH_DATE) = 1 
		AND LEFT(MTH_DATE, 4) >= '2015') 
, TRADE_DAILY AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS MTH_DATE
FROM ODS.dbo.ST_DAT200_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LEFT(DATE_YMD, 4) >= '2015')
SELECT C.S_IDNO AS S_IDNO
FROM(
SELECT CUSTOMER_INFO.S_IDNO AS S_IDNO,
		COUNT(DISTINCT(MATCH_DAY.MTH_DATE)) AS TRADE_DAY_TOTAL
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN MATCH_DAY ON STAT_DAY.S_ACNO = MATCH_DAY.S_ACNO AND STAT_DAY.DATE_YMD = MATCH_DAY.MTH_DATE AND STAT_DAY.BROKER_NO4 = MATCH_DAY.BROKER_NO4
GROUP BY CUSTOMER_INFO.S_IDNO) C
LEFT JOIN(
SELECT A.S_IDNO,
		COUNT(*) AS NOT_DAILY_TRADE_DAY
FROM(
SELECT MATCH_DAY.MTH_DATE AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		COUNT(*) AS TOTAL_MATCH
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN MATCH_DAY ON STAT_DAY.S_ACNO = MATCH_DAY.S_ACNO AND STAT_DAY.DATE_YMD = MATCH_DAY.MTH_DATE AND STAT_DAY.BROKER_NO4 = MATCH_DAY.BROKER_NO4
GROUP BY MATCH_DAY.MTH_DATE, CUSTOMER_INFO.S_IDNO) A
LEFT JOIN(
SELECT TRADE_DAILY.MTH_DATE AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		COUNT(*) AS TOTAL_DAILY
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN TRADE_DAILY ON STAT_DAY.S_ACNO = TRADE_DAILY.S_ACNO AND STAT_DAY.DATE_YMD = TRADE_DAILY.MTH_DATE AND STAT_DAY.BROKER_NO4 = TRADE_DAILY.BROKER_NO4
GROUP BY TRADE_DAILY.MTH_DATE, CUSTOMER_INFO.S_IDNO) B
ON A.MTH_DATE = B.MTH_DATE AND A.S_IDNO = B.S_IDNO
WHERE B.TOTAL_DAILY/A.TOTAL_MATCH <= 0.5
GROUP BY A.S_IDNO) D
ON C.S_IDNO = D.S_IDNO
WHERE D.NOT_DAILY_TRADE_DAY/C.TRADE_DAY_TOTAL >= 0.5


-- 當沖佔當日交易比例
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
        RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
        RTRIM(LTRIM(BROKER_NO4)) AS BROKER_NO4,
        CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD,
		AMT
FROM ODS.dbo.STS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015'
		AND STATIC_CODE = '000')
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BIRTH) = 1 THEN DATEDIFF(YEAR, S_BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.ST_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BIRTH) = 1)
, TRADE_DAILY AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS MTH_DATE,
		[D2012] AS MTH_AMT
FROM ODS.dbo.ST_DAT200_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LEFT(DATE_YMD, 4) >= '2015')
SELECT COUNT(DISTINCT(C.S_IDNO)) AS TOTAL_ID,
		COUNT(*) AS TOTAL,
		AVG(DAY_TRADE_RATIO) AS DAY_TRADE_RATIO_MEAN,
		STDEV(DAY_TRADE_RATIO) AS DAY_TRADE_RATIO_STD
FROM(
SELECT A.S_IDNO,
		A.MTH_DATE,
		CONVERT(FLOAT, A.TOTAL_DAILY)/CONVERT(FLOAT, A.TOTAL_MATCH) AS DAY_TRADE_RATIO
FROM(
SELECT TRADE_DAILY.MTH_DATE AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		SUM(MTH_AMT) AS TOTAL_DAILY,
		SUM(AMT) AS TOTAL_MATCH
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO
INNER JOIN TRADE_DAILY ON STAT_DAY.S_ACNO = TRADE_DAILY.S_ACNO AND STAT_DAY.DATE_YMD = TRADE_DAILY.MTH_DATE AND STAT_DAY.BROKER_NO4 = TRADE_DAILY.BROKER_NO4
GROUP BY TRADE_DAILY.MTH_DATE, CUSTOMER_INFO.S_IDNO) A) C


-- 靜止戶探索分析
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
        CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD,
		SUM(AMT) AS AMT
FROM ODS.dbo.STS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015'
		AND STATIC_CODE = '000'
		AND AMT != 0
GROUP BY RTRIM(LTRIM(S_IDNO)), DATE_YMD)
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(BROKER_NO4_EX)) AS BROKER_NO4,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BIRTH) = 1 THEN DATEDIFF(YEAR, S_BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.ST_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BIRTH) = 1)
SELECT CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END)) AS CHURN_FEMALE_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END)) AS CHURN_MALE_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_TOTAL,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_TOTAL,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END)) AS CHURN_2015_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END)) AS CHURN_2016_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END)) AS CHURN_2017_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END)) AS CHURN_2018_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' THEN S_IDNO ELSE NULL END) AS CHURN_TOTAL_ID,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'ACTIVE' THEN S_IDNO ELSE NULL END) AS ACTIVE_TOTAL_ID,
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END)) AS CHURN_AGE_AVG, 
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END)) AS ACTIVE_AGE_AVG,
		SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END) AS CHURN_TOTAL,
		SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END) AS ACTIVE_TOTAL
FROM(
SELECT MTH_DATE,
		S_IDNO,
		GENDER,
		AGE,
		AMT,
		CASE WHEN DATEDIFF(DAY, MTH_DATE, NEXT_TRADES) < 360 THEN 'ACTIVE' ELSE 'CHURN' END AS LABEL_CHURN
FROM(
SELECT STAT_DAY.DATE_YMD AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		CUSTOMER_INFO.GENDER AS GENDER,
		CUSTOMER_INFO.AGE AS AGE,
		FIRST_VALUE(STAT_DAY.DATE_YMD) OVER (PARTITION BY STAT_DAY.S_IDNO ORDER BY STAT_DAY.DATE_YMD ASC ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS NEXT_TRADES,
		AMT
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO) A
WHERE MTH_DATE < DATEADD(DAY, -1, CONVERT(DATE, GETDATE()))) B


-- 期貨
WITH STAT_DAY AS(
SELECT S_IDNO,
		DATE_YMD,
		SUM(QTY) AS QTY
FROM(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
        RTRIM(LTRIM(F_ACNO)) AS F_ACNO,
        CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD,
		QTY_T + QTY_F + QTY_O AS QTY
FROM ODS.dbo.FUS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015')C
WHERE QTY != 0
GROUP BY S_IDNO, DATE_YMD)
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(FU_BK_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(S_BDATE) = 1 THEN DATEDIFF(YEAR, S_BDATE, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.FU_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(S_BDATE) = 1)
SELECT CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END)) AS CHURN_FEMALE_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END)) AS CHURN_MALE_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_TOTAL,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_TOTAL,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END)) AS CHURN_2015_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END)) AS CHURN_2016_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END)) AS CHURN_2017_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END)) AS CHURN_2018_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' THEN S_IDNO ELSE NULL END) AS CHURN_TOTAL_ID,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'ACTIVE' THEN S_IDNO ELSE NULL END) AS ACTIVE_TOTAL_ID,
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END)) AS CHURN_AGE_AVG, 
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END)) AS CHURN_AGE_AVG,
		SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END) AS CHURN_TOTAL,
		SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END) AS ACTIVE_TOTAL
FROM(
SELECT MTH_DATE,
		S_IDNO,
		GENDER,
		AGE,
		QTY,
		CASE WHEN DATEDIFF(DAY, MTH_DATE, NEXT_TRADES) < 360 THEN 'ACTIVE' ELSE 'CHURN' END AS LABEL_CHURN
FROM(
SELECT STAT_DAY.DATE_YMD AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		CUSTOMER_INFO.GENDER AS GENDER,
		CUSTOMER_INFO.AGE AS AGE,
		FIRST_VALUE(STAT_DAY.DATE_YMD) OVER (PARTITION BY STAT_DAY.S_IDNO ORDER BY STAT_DAY.DATE_YMD ASC ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS NEXT_TRADES,
		QTY
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO) A
WHERE MTH_DATE < DATEADD(DAY, -1, CONVERT(DATE, GETDATE()))) B

-- 複委託
WITH STAT_DAY AS(
SELECT RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN ISDATE(DATE_YMD) = 1 THEN CONVERT(DATE, DATE_YMD) ELSE NULL END AS DATE_YMD,
		SUM(AMT_TW) AS AMT
FROM ODS.dbo.SUBS_MATCH_CUSTOMER_D
WHERE ISDATE(DATE_YMD) = 1 
		AND LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1
		AND RTRIM(LTRIM(S_IDNO)) IN (SELECT DISTINCT(RTRIM(LTRIM(S_IDNO))) FROM ODS.dbo.ST_CUSTOMER)
		AND LEFT(DATE_YMD, 4) >= '2015'
		AND AMT_TW != 0
GROUP BY S_IDNO, DATE_YMD)
, CUSTOMER_INFO AS(
SELECT RTRIM(LTRIM(S_ACNO)) AS S_ACNO,
		RTRIM(LTRIM(S_IDNO)) AS S_IDNO,
		CASE WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '1' THEN 'M'
			WHEN S_IDNO LIKE '[A-Z]%' AND SUBSTRING(S_IDNO, 2, 1) = '2' THEN 'F' ELSE 'N' END AS GENDER,
		CASE WHEN ISDATE(BIRTH) = 1 THEN DATEDIFF(YEAR, BIRTH, CONVERT(DATE, GETDATE())) ELSE NULL END AS [AGE]
FROM ODS.dbo.SUB_CUSTOMER
WHERE LTRIM(RTRIM(S_IDNO)) LIKE '[A-Z]%' 
		AND SUBSTRING(LTRIM(RTRIM(S_IDNO)), 2, 1) IN ('1', '2') 
		AND ISNUMERIC(RIGHT(LTRIM(RTRIM(S_IDNO)), 8)) = 1 
		AND ISDATE(BIRTH) = 1)
SELECT CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END)) AS CHURN_FEMALE_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END)) AS CHURN_MALE_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'F' THEN S_IDNO ELSE NULL END) AS FEMALE_TOTAL,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_CHURN,
		COUNT(DISTINCT CASE WHEN GENDER = 'M' THEN S_IDNO ELSE NULL END) AS MALE_TOTAL,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2015' THEN S_IDNO ELSE NULL END)) AS CHURN_2015_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2016' THEN S_IDNO ELSE NULL END)) AS CHURN_2016_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2017' THEN S_IDNO ELSE NULL END)) AS CHURN_2017_RATIO,
		CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' AND LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END))/CONVERT(FLOAT, COUNT(DISTINCT CASE WHEN LEFT(MTH_DATE, 4) = '2018' THEN S_IDNO ELSE NULL END)) AS CHURN_2018_RATIO,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'CHURN' THEN S_IDNO ELSE NULL END) AS CHURN_TOTAL_ID,
		COUNT(DISTINCT CASE WHEN LABEL_CHURN = 'ACTIVE' THEN S_IDNO ELSE NULL END) AS ACTIVE_TOTAL_ID,
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END)) AS CHURN_AGE_AVG, 
		CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN AGE ELSE 0 END))/CONVERT(FLOAT, SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END)) AS ACTIVE_AGE_AVG,
		SUM(CASE WHEN LABEL_CHURN = 'CHURN' THEN 1 ELSE 0 END) AS CHURN_TOTAL,
		SUM(CASE WHEN LABEL_CHURN = 'ACTIVE' THEN 1 ELSE 0 END) AS ACTIVE_TOTAL
FROM(
SELECT MTH_DATE,
		S_IDNO,
		GENDER,
		AGE,
		AMT,
		CASE WHEN DATEDIFF(DAY, MTH_DATE, NEXT_TRADES) < 360 THEN 'ACTIVE' ELSE 'CHURN' END AS LABEL_CHURN
FROM(
SELECT STAT_DAY.DATE_YMD AS MTH_DATE,
        CUSTOMER_INFO.S_IDNO AS S_IDNO,
		CUSTOMER_INFO.GENDER AS GENDER,
		CUSTOMER_INFO.AGE AS AGE,
		FIRST_VALUE(STAT_DAY.DATE_YMD) OVER (PARTITION BY STAT_DAY.S_IDNO ORDER BY STAT_DAY.DATE_YMD ASC ROWS BETWEEN 1 FOLLOWING AND UNBOUNDED FOLLOWING) AS NEXT_TRADES,
		AMT
FROM STAT_DAY
INNER JOIN CUSTOMER_INFO ON STAT_DAY.S_IDNO = CUSTOMER_INFO.S_IDNO)A
WHERE MTH_DATE < DATEADD(DAY, -1, CONVERT(DATE, GETDATE()))) B